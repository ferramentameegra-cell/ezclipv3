[phases.setup]
nixPkgs = ["ffmpeg", "python3", "pip", "curl"]

[phases.install]
cmds = [
  # Instalar yt-dlp como binário diretamente (mais confiável que pip)
  "curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp || curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /tmp/yt-dlp",
  "chmod a+rx /usr/local/bin/yt-dlp 2>/dev/null || chmod a+rx /tmp/yt-dlp 2>/dev/null || true",
  "mv /tmp/yt-dlp /usr/local/bin/yt-dlp 2>/dev/null || true",
  # Fallback: instalar via pip se o binário falhar
  "pip install yt-dlp || true",
  # Instalar dependências npm (usar npm ci para produção, fallback para npm install)
  "npm ci --prefer-offline --no-audit || npm install --prefer-offline --no-audit",
  # Verificar se helmet foi instalado
  "npm list helmet || npm install helmet@^7.1.0",
  # Criar diretório para assets e copiar background
  "mkdir -p /tmp/assets/backgrounds",
  "cp assets/backgrounds/ezclip-background.png /tmp/assets/backgrounds/ 2>/dev/null || cp assets/backgrounds/ezclip-background.jpg /tmp/assets/backgrounds/ 2>/dev/null || echo 'Background não encontrado, será usado fallback'"
]

[phases.build]
cmds = ["npm run build"]

[start]
cmd = "node src/index.js"

[variables]
NIXPACKS_NODE_VERSION = "20"
